/**
 * copyright (c) 2013, by Lizzie DeYoung. All rights reserved.
 * Text, graphics, and HTML code are protected by US and International
 * Copyright Laws, and may not be copied, reprinted, published,
 * translated, hosted, or otherwise distributed by any means without
 * explicit permission.
*/
function RadialPoint(){this.current=null;this.upper_bound=null;this.lower_bound=null;this.time=-1;this.upper_time=-1;this.lower_time=-1;this.should_refine_later=false;this.is_estimate=true;this.update_bounds=function(e){if(time_radius.num_iterations==0)return;if(this.time>=0){if(this.time<=e&&(this.lower_time<0||this.lower_time<this.time)){this.lower_bound=this.current;this.lower_time=this.time}else if(this.time>e&&(this.upper_time<0||this.upper_time>this.time)){this.upper_bound=this.current;this.upper_time=this.time}}};this.refine_later=function(e,t,n){var r;var i;if(n){r=(this.current.lat()-t.lat())*e;i=(this.current.lng()-t.lng())*e}else{if(e==1||!this.should_refine_later){return}else if(e>1){r=(this.current.lat()-t.lat())*2;i=(this.current.lng()-t.lng())*2}else if(e<1){r=(this.current.lat()-t.lat())/2;i=(this.current.lng()-t.lng())/2}}this.current=new google.maps.LatLng(t.lat()+r,t.lng()+i);this.should_refine_later=false};this.refine_with_upper_lower=function(e,t){var n=this.upper_bound.lat()-this.lower_bound.lat();var r=this.upper_bound.lng()-this.lower_bound.lng();var i=n/2;var s=r/2;var o=(e-this.lower_time)/(this.upper_time-this.lower_time);var u=n*o;var a=r*o;var f=(i-u)/2;var l=(s-a)/2;var c=i-f;var h=s-l;this.current=new google.maps.LatLng(this.lower_bound.lat()+c,this.lower_bound.lng()+h);var p=(c/t.lat()+h/t.lng())/2;return p};this.refine_with_time=function(e,t){var n=e/this.time;if(time_radius.num_iterations==0){if(e<this.time)n/=2;if(e>this.time)n*=2}var r=(this.current.lat()-t.lat())*n;var i=(this.current.lng()-t.lng())*n;this.current=new google.maps.LatLng(t.lat()+r,t.lng()+i);return n};this.refine=function(e,t){var n=this.time;this.should_refine_later=false;this.update_bounds(e);if(this.upper_bound!=null&&this.lower_bound!=null){this.is_estimate=false;return this.refine_with_upper_lower(e,t)}else if(this.time>=0){this.is_estimate=false;return this.refine_with_time(e,t)}else{this.should_refine_later=true;this.is_estimate=true;return 1}}}function TimeRadius(e){this.map=null;this.points=new Array;this.time=20;this.error=1;this.num_points=20;this.max_iterations=5;this.num_iterations=0;if(e["center"]){this.center=e["center"]}else{alert("center is a required argument")}if(e["time"]){this.time=e["time"]}if(e["num_points"]){this.num_points=e["num_points"]}if(e["num_iterations"]){this.num_iterations=e["num_iterations"]}for(var t=0;t<this.num_points;t++){var n=this.center.lat()+Math.sin(2*Math.PI*t/this.num_points);var r=this.center.lng()+Math.cos(2*Math.PI*t/this.num_points);var i=new RadialPoint;i.current=new google.maps.LatLng(n,r);this.points[t]=i}this.refine_points=function(){var e=0;var t=0;for(var n in this.points){var r=this.points[n];var i=r.refine(this.time,this.center);if(!r.should_refine_later){e+=i;t++}}e/=t;for(var n in this.points){var r=this.points[n];if(r.should_refine_later){var s=this.num_iterations==0;r.refine_later(e,this.center,s)}}this.num_iterations+=1;if(this.num_iterations==this.max_iterations){for(var n in this.points){var r=this.points[n];if(r.upper_bound!=null&&r.upper_time-this.time<this.error&&r.upper_time-this.time<this.time-r.lower_time){r.current=r.upper_bound;r.time=r.upper_time}else if(r.lower_bound!=null){r.current=r.lower_bound;r.time=r.lower_time}else{r.current=null}}}if(this.num_iterations<this.max_iterations){return true}else{return false}};this.process_times=function(e){for(var t=0;t<e.length;t++){var n=e[t];this.points[t].time=-1;if(n.status=="OK"){this.points[t].time=n.duration.value/60}}};this.get_point_array=function(){var e=new Array;for(t in this.points){e[t]=this.points[t].current}return e};this.get_culled_point_array=function(){var e=new Array;var n=0;for(t in this.points){if(this.points[t].current!=null){e[n]=this.points[t].current;n++}}return e};this.get_bounds=function(){var e=null;var n=null;var r=null;var i=null;for(t in this.points){if(this.points[t].current!=null){var s=this.points[t].current.lat();var o=this.points[t].current.lng();if(e==null||e<s){e=s}if(n==null||n>s){n=s}if(i==null||i<o){i=o}if(r==null||r>o){r=o}}}var u=new google.maps.LatLng(e,i);var a=new google.maps.LatLng(n,r);var f=new google.maps.LatLngBounds(a,u);return f}}function MapContainer(e){this.map=null;this.boundary=new Array;this.boundary_overlay=null;this.center=null;this.set_boundary=function(e,t){if(this.map==null){alert("map can't be null")}if(this.center!=null){this.center.setMap(null)}this.center=new google.maps.Marker({position:t,map:this.map});if(this.boundary_overlay!=null){this.boundary_overlay.setMap(null)}var n=time_radius.get_culled_point_array();this.boundary_overlay=new google.maps.Polygon({paths:n,strokeColor:"#0000FF",strokeOpacity:1,strokeWeight:2,fillColor:"#0000FF",fillWeight:.5});this.boundary_overlay.setMap(this.map)}}function FormContainer(e){this.map=document.getElementById("map-container");this.address=document.getElementById("address");this.route_type=document.getElementById("route-type");this.get_address=function(){return this.address.value.toString()};this.get_time=function(){var e=document.getElementById("minutes").value;var t=document.getElementById("hours").value;var n=0;if(t!=null){t=parseInt(t);if(t>=0){n=t*60}}if(e!=null){e=parseInt(e);if(e>=0){n+=e}}if(n>0){return n}alert("time inputs must be greater than 0")};this.get_route_type=function(){var e=this.route_type.value.toString();return google.maps.TravelMode[e]}}function Services(e){this.distance_matrix=new google.maps.DistanceMatrixService;this.geocoder=new google.maps.Geocoder}function initialize(){form_container=new FormContainer(null);map_container=new MapContainer(null);services=new Services(null);var e=new google.maps.LatLng(39.8282,-98.5795);map_container.map=new google.maps.Map(form_container.map,{zoom:4,center:e,mapTypeId:google.maps.MapTypeId.ROADMAP})}function run(){var e=form_container.get_address();services.geocoder.geocode({address:e},find_time_radius)}function find_time_radius(e,t){if(t=="OK"){var n=e[0].geometry.location;var r=form_container.get_time();time_radius=new TimeRadius({center:n,time:r});map_container.map.setCenter(time_radius.center);get_time_bounds()}}function get_time_bounds(){console.log("hit "+number+" times");number++;if(number>100){var e=true}services.distance_matrix.getDistanceMatrix({origins:[time_radius.center],destinations:time_radius.get_point_array(),travelMode:form_container.get_route_type(),durationInTraffic:true,avoidHighways:false,avoidTolls:false},calculate_time_bounds)}function calculate_time_bounds(e,t){if(t=="OK"){time_radius.process_times(e.rows[0].elements);output_times(e);var n=time_radius.refine_points();if(n){get_time_bounds()}else{map_container.set_boundary(time_radius.points,time_radius.center);map_container.map.fitBounds(time_radius.get_bounds())}}else{setTimeout(get_time_bounds,1e3)}}function output_times(e){var t=document.getElementById("dir-container");for(var n=0;n<e.rows.length;n++){for(var r=0;r<e.rows[n].elements.length;r++){var i=e.rows[n].elements[r];var s="not found; ";if(i.status=="OK"){var s=i.duration.text+"; "}else{var s=i.status}var o=document.createTextNode(s);t.appendChild(o)}}}function check_heights(){alert($("#map-holder").outerHeight())}function set_map_size(){var e=$("#map-holder").innerHeight();var t=$("#map-holder").innerWidth();var n=30;var r=$("#map-container");r.css("height",e);r.css("width",t-n)}var form_container=null;var time_radius=null;var map_container=null;var services=null;var number=0;$(document).ready(function(){set_map_size()});$(window).resize(function(){set_map_size()})